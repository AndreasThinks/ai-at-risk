<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI at Risk - Game Setup</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            color: white;
            font-size: 2.5em;
            font-weight: 300;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            margin-bottom: 10px;
        }

        .header .subtitle {
            color: rgba(255,255,255,0.8);
            font-size: 1.2em;
            font-weight: 300;
        }

        .setup-wizard {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.2);
            overflow: hidden;
            min-height: 600px;
        }

        .wizard-header {
            background: linear-gradient(45deg, #3498db, #2980b9);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .wizard-title {
            font-size: 1.8em;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .wizard-subtitle {
            font-size: 1em;
            opacity: 0.9;
        }

        .progress-bar {
            background: rgba(255,255,255,0.2);
            height: 6px;
            border-radius: 3px;
            margin-top: 20px;
            overflow: hidden;
        }

        .progress-fill {
            background: white;
            height: 100%;
            border-radius: 3px;
            transition: width 0.3s ease;
            width: 33.33%;
        }

        .wizard-content {
            padding: 40px;
        }

        .step {
            display: none;
        }

        .step.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-label {
            display: block;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 8px;
            font-size: 1.1em;
        }

        .form-input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1em;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        .form-select {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1em;
            background: white;
            cursor: pointer;
            transition: border-color 0.3s ease;
        }

        .form-select:focus {
            outline: none;
            border-color: #3498db;
        }

        .form-textarea {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1em;
            resize: vertical;
            min-height: 100px;
            font-family: inherit;
            transition: border-color 0.3s ease;
        }

        .form-textarea:focus {
            outline: none;
            border-color: #3498db;
        }

        .form-help {
            font-size: 0.9em;
            color: #666;
            margin-top: 5px;
            line-height: 1.4;
        }

        .player-count-selector {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
            gap: 15px;
            margin-top: 10px;
        }

        .player-count-option {
            background: #f8f9fa;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            font-size: 1.1em;
        }

        .player-count-option:hover {
            background: #e3f2fd;
            border-color: #3498db;
            transform: translateY(-2px);
        }

        .player-count-option.selected {
            background: #3498db;
            color: white;
            border-color: #2980b9;
        }

        .personality-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 15px;
        }

        .personality-card {
            background: #f8f9fa;
            border: 2px solid #e0e0e0;
            border-radius: 15px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .personality-card:hover {
            background: #e3f2fd;
            border-color: #3498db;
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .personality-card.selected {
            background: linear-gradient(45deg, #3498db, #2980b9);
            color: white;
            border-color: #2980b9;
        }

        .personality-title {
            font-size: 1.2em;
            font-weight: 600;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
        }

        .personality-emoji {
            font-size: 1.5em;
            margin-right: 10px;
        }

        .personality-description {
            font-size: 0.9em;
            line-height: 1.4;
            opacity: 0.8;
        }

        .model-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 15px;
        }

        .model-card {
            background: #f8f9fa;
            border: 2px solid #e0e0e0;
            border-radius: 15px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .model-card:hover {
            background: #e3f2fd;
            border-color: #3498db;
            transform: translateY(-2px);
        }

        .model-card.selected {
            background: linear-gradient(45deg, #3498db, #2980b9);
            color: white;
            border-color: #2980b9;
        }

        .model-name {
            font-size: 1.2em;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .model-description {
            font-size: 0.9em;
            line-height: 1.4;
            opacity: 0.8;
            margin-bottom: 10px;
        }

        .model-specs {
            font-size: 0.8em;
            opacity: 0.7;
        }

        .temperature-slider {
            margin-top: 15px;
        }

        .slider-container {
            position: relative;
            margin: 20px 0;
        }

        .slider {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: #e0e0e0;
            outline: none;
            -webkit-appearance: none;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #3498db;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
        }

        .slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #3498db;
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
        }

        .slider-labels {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
            font-size: 0.8em;
            color: #666;
        }

        .temperature-value {
            background: #3498db;
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9em;
            display: inline-block;
            margin-left: 10px;
        }

        .player-setup-card {
            background: #f8f9fa;
            border: 2px solid #e0e0e0;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            transition: all 0.3s ease;
        }

        .player-setup-card.active {
            border-color: #3498db;
            background: #e3f2fd;
        }

        .player-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .player-number {
            background: #3498db;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 1.2em;
        }

        .player-form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .player-form-full {
            grid-column: 1 / -1;
        }

        .review-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .review-card {
            background: #f8f9fa;
            border: 2px solid #e0e0e0;
            border-radius: 15px;
            padding: 20px;
        }

        .review-player-name {
            font-size: 1.3em;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
        }

        .review-player-number {
            background: #3498db;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            margin-right: 10px;
        }

        .review-detail {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 0.9em;
        }

        .review-label {
            font-weight: 600;
            color: #666;
        }

        .review-value {
            color: #2c3e50;
        }

        .wizard-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 40px;
            padding-top: 30px;
            border-top: 2px solid #f0f0f0;
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 25px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(45deg, #3498db, #2980b9);
            color: white;
            box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(52, 152, 219, 0.4);
        }

        .btn-secondary {
            background: #95a5a6;
            color: white;
        }

        .btn-secondary:hover {
            background: #7f8c8d;
            transform: translateY(-2px);
        }

        .btn-success {
            background: linear-gradient(45deg, #27ae60, #2ecc71);
            color: white;
            box-shadow: 0 4px 15px rgba(39, 174, 96, 0.3);
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(39, 174, 96, 0.4);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }

        .error-message {
            background: #e74c3c;
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            display: none;
        }

        .success-message {
            background: #27ae60;
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            display: none;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 40px;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .config-actions {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
        }

        .quick-preset-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .preset-card {
            background: #f8f9fa;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .preset-card:hover {
            background: #e3f2fd;
            border-color: #3498db;
            transform: translateY(-2px);
        }

        .preset-title {
            font-weight: 600;
            margin-bottom: 5px;
        }

        .preset-description {
            font-size: 0.8em;
            color: #666;
        }

        .character-count {
            font-size: 0.8em;
            color: #666;
            text-align: right;
            margin-top: 5px;
        }

        .validation-error {
            color: #e74c3c;
            font-size: 0.9em;
            margin-top: 5px;
            display: none;
        }

        .form-input.error {
            border-color: #e74c3c;
        }

        .info-box {
            background: linear-gradient(45deg, #e3f2fd, #f3e5f5);
            border: 2px solid #3498db;
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            display: flex;
            align-items: flex-start;
            gap: 15px;
        }

        .info-icon {
            font-size: 1.5em;
            color: #3498db;
            flex-shrink: 0;
        }

        .info-content {
            flex: 1;
            line-height: 1.5;
        }

        .info-content strong {
            color: #2c3e50;
            display: block;
            margin-bottom: 5px;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .header h1 {
                font-size: 2em;
            }

            .wizard-content {
                padding: 20px;
            }

            .player-form-grid {
                grid-template-columns: 1fr;
            }

            .personality-grid {
                grid-template-columns: 1fr;
            }

            .model-grid {
                grid-template-columns: 1fr;
            }

            .review-grid {
                grid-template-columns: 1fr;
            }

            .wizard-actions {
                flex-direction: column;
                gap: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🎲 AI at Risk - Game Setup</h1>
            <div class="subtitle">Configure your AI agents and start the battle for world domination</div>
            <div style="font-size: 0.9rem; opacity: 0.8; margin-top: 10px;">
                A project by <a href="https://andreasthinks.me/posts/ai-at-play/" target="_blank" style="color: #fff; text-decoration: underline;">AndreasThinks</a> (and some ✨vibes✨)
            </div>
            <div style="margin-top: 15px;">
                <a href="/tournament_leaderboard.html" target="_blank" style="
                    display: inline-block;
                    background: rgba(255, 255, 255, 0.2);
                    color: white;
                    text-decoration: none;
                    padding: 8px 16px;
                    border-radius: 20px;
                    font-size: 0.9rem;
                    transition: all 0.3s;
                    backdrop-filter: blur(10px);
                " onmouseover="this.style.background='rgba(255, 255, 255, 0.3)'; this.style.transform='translateY(-2px)'" 
                   onmouseout="this.style.background='rgba(255, 255, 255, 0.2)'; this.style.transform='translateY(0)'">
                    🏆 View Tournament Leaderboard
                </a>
            </div>
        </div>

        <div class="setup-wizard">
            <div class="wizard-header">
                <div class="wizard-title" id="wizard-title">Game Configuration</div>
                <div class="wizard-subtitle" id="wizard-subtitle">Set up your Risk game parameters</div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progress-fill"></div>
                </div>
            </div>

            <div class="wizard-content">
                <div class="error-message" id="error-message"></div>
                <div class="success-message" id="success-message"></div>

                <!-- Step 1: Game Configuration -->
                <div class="step active" id="step-1">
                    <div class="config-actions">
                        <button class="btn btn-secondary" onclick="loadConfiguration()">📁 Load Configuration</button>
                        <button class="btn btn-secondary" onclick="showQuickPresets()">⚡ Quick Presets</button>
                    </div>

                    <div class="quick-preset-grid" id="quick-presets" style="display: none;">
                        <div class="preset-card" onclick="loadQuickPreset('balanced')">
                            <div class="preset-title">⚖️ Balanced Game</div>
                            <div class="preset-description">4 players with mixed strategies</div>
                        </div>
                        <div class="preset-card" onclick="loadQuickPreset('aggressive')">
                            <div class="preset-title">⚔️ War Zone</div>
                            <div class="preset-description">6 aggressive players</div>
                        </div>
                        <div class="preset-card" onclick="loadQuickPreset('diplomatic')">
                            <div class="preset-title">🤝 Diplomacy</div>
                            <div class="preset-description">4 diplomatic players</div>
                        </div>
                        <div class="preset-card" onclick="loadQuickPreset('mixed')">
                            <div class="preset-title">🎭 Mixed Personalities</div>
                            <div class="preset-description">5 players with different styles</div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="game-name">Game Name (Optional)</label>
                        <input type="text" id="game-name" class="form-input" placeholder="Enter a name for your game">
                        <div class="form-help">Give your game a memorable name, or leave blank for auto-generation</div>
                    </div>

                    <div class="info-box">
                        <div class="info-icon">ℹ️</div>
                        <div class="info-content">
                            <strong>API Configuration</strong><br>
                            API credentials are configured server-side for security. You can only customize player personalities and AI models.
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Number of Players</label>
                        <div class="player-count-selector">
                            <div class="player-count-option" onclick="selectPlayerCount(2)">2</div>
                            <div class="player-count-option" onclick="selectPlayerCount(3)">3</div>
                            <div class="player-count-option selected" onclick="selectPlayerCount(4)">4</div>
                            <div class="player-count-option" onclick="selectPlayerCount(5)">5</div>
                            <div class="player-count-option" onclick="selectPlayerCount(6)">6</div>
                        </div>
                        <div class="form-help">Choose between 2-6 AI agents to compete for world domination</div>
                    </div>
                </div>

                <!-- Step 2: Player Configuration -->
                <div class="step" id="step-2">
                    <div id="players-container">
                        <!-- Player cards will be generated here -->
                    </div>
                </div>

                <!-- Step 3: Review and Launch -->
                <div class="step" id="step-3">
                    <div class="form-group">
                        <label class="form-label">Game Summary</label>
                        <div id="game-summary"></div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Player Configuration</label>
                        <div class="review-grid" id="review-grid">
                            <!-- Review cards will be generated here -->
                        </div>
                    </div>

                    <div class="form-group">
                        <button class="btn btn-secondary" onclick="saveConfiguration()">💾 Save Configuration</button>
                        <div class="form-help">Save this configuration for future use</div>
                    </div>
                </div>

                <div class="loading" id="loading">
                    <div class="loading-spinner"></div>
                    <div>Creating your Risk game...</div>
                </div>

                <div class="wizard-actions" id="wizard-actions">
                    <button class="btn btn-secondary" id="prev-btn" onclick="previousStep()" style="display: none;">← Previous</button>
                    <div></div>
                    <button class="btn btn-primary" id="next-btn" onclick="nextStep()">Next →</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let currentStep = 1;
        let playerCount = 4;
        let gameConfig = {
            gameName: '',
            players: []
        };

        // Models will be loaded from API
        let availableModels = {};
        let defaultModel = 'gpt-3.5-turbo';

        const personalityTemplates = {
            aggressive: {
                emoji: '⚔️',
                title: 'Aggressive Conqueror',
                description: 'Focuses on rapid expansion and constant warfare. Prefers attacking over defending.',
                instructions: 'You are an aggressive military commander who believes the best defense is a good offense. Always look for opportunities to attack and expand your territory. Take calculated risks and don\'t be afraid to engage in combat. Your goal is rapid territorial expansion through decisive military action.'
            },
            diplomatic: {
                emoji: '🤝',
                title: 'Master Diplomat',
                description: 'Uses negotiation and alliances to achieve victory. Prefers cooperation over conflict.',
                instructions: 'You are a skilled diplomat who prefers negotiation over warfare. Form strategic alliances, engage in trade negotiations, and use communication to achieve your goals. Only fight when absolutely necessary, and always look for peaceful solutions. Your strength lies in building relationships and coordinating with other players.'
            },
            defensive: {
                emoji: '🛡️',
                title: 'Fortress Builder',
                description: 'Prioritizes strong defenses and careful expansion. Plays conservatively and methodically.',
                instructions: 'You are a cautious strategist who prioritizes defense and careful planning. Build strong defensive positions, expand methodically, and avoid unnecessary risks. Focus on securing key territories and maintaining strong borders. Only attack when you have overwhelming advantage or when defending your interests.'
            },
            balanced: {
                emoji: '⚖️',
                title: 'Strategic Tactician',
                description: 'Adapts strategy based on game situation. Balances offense, defense, and diplomacy.',
                instructions: 'You are a balanced strategist who adapts your approach based on the current game situation. Use a mix of military action, diplomatic negotiation, and defensive positioning. Be flexible in your tactics and respond appropriately to threats and opportunities. Your strength is in reading the game state and choosing the right approach for each situation.'
            },
            opportunistic: {
                emoji: '🎯',
                title: 'Opportunistic Schemer',
                description: 'Waits for the perfect moment to strike. Exploits weaknesses and chaos.',
                instructions: 'You are an opportunistic player who excels at identifying and exploiting weaknesses. Wait for the right moments to make your moves, take advantage of other players\' conflicts, and strike when enemies are vulnerable. Be patient, observe carefully, and capitalize on opportunities that others miss.'
            },
            economic: {
                emoji: '💰',
                title: 'Economic Powerhouse',
                description: 'Focuses on resource management and steady growth. Builds economic advantages.',
                instructions: 'You are focused on building economic and resource advantages. Prioritize territories that provide good army bonuses, manage your resources efficiently, and build a strong economic foundation. Use your superior resource management to outlast opponents and build overwhelming advantages over time.'
            }
        };

        // Initialize the wizard
        async function initializeWizard() {
            updateProgressBar();
            await loadAvailableModels();
            generatePlayerCards();
        }

        // Load available models from API
        async function loadAvailableModels() {
            try {
                const response = await fetch('/api/models');
                if (response.ok) {
                    const data = await response.json();
                    availableModels = data.models;
                    defaultModel = data.default_model;
                } else {
                    console.warn('Failed to load models from API, using fallback');
                    // Fallback models
                    availableModels = {
                        'gpt-3.5-turbo': {
                            name: 'GPT-3.5 Turbo',
                            description: 'Fast and efficient model',
                            defaultTemp: 0.8,
                            specs: 'Cost-effective choice'
                        }
                    };
                }
            } catch (error) {
                console.error('Error loading models:', error);
                // Use fallback models
                availableModels = {
                    'gpt-3.5-turbo': {
                        name: 'GPT-3.5 Turbo',
                        description: 'Fast and efficient model',
                        defaultTemp: 0.8,
                        specs: 'Cost-effective choice'
                    }
                };
            }
        }

        // Update progress bar
        function updateProgressBar() {
            const progress = (currentStep / 3) * 100;
            document.getElementById('progress-fill').style.width = progress + '%';
            
            const titles = ['Game Configuration', 'Player Setup', 'Review & Launch'];
            const subtitles = [
                'Set up your Risk game parameters',
                'Configure each AI agent\'s personality and model',
                'Review settings and start the game'
            ];
            
            document.getElementById('wizard-title').textContent = titles[currentStep - 1];
            document.getElementById('wizard-subtitle').textContent = subtitles[currentStep - 1];
        }

        // Player count selection
        function selectPlayerCount(count) {
            playerCount = count;
            document.querySelectorAll('.player-count-option').forEach(option => {
                option.classList.remove('selected');
            });
            event.target.classList.add('selected');
            generatePlayerCards();
        }

        // Generate player configuration cards
        function generatePlayerCards() {
            const container = document.getElementById('players-container');
            container.innerHTML = '';
            
            // Initialize players array if needed
            while (gameConfig.players.length < playerCount) {
                const defaultModelName = Object.values(availableModels)[0]?.name || 'gpt-3.5-turbo';
                const defaultTemp = Object.values(availableModels)[0]?.defaultTemp || 0.8;
                
                gameConfig.players.push({
                    name: `Player ${gameConfig.players.length + 1}`,
                    model: defaultModelName,
                    temperature: defaultTemp,
                    personality: 'balanced',
                    customInstructions: personalityTemplates.balanced.instructions,
                    useCustomInstructions: false,
                    customModelName: ''
                });
            }
            
            // Remove excess players
            gameConfig.players = gameConfig.players.slice(0, playerCount);
            
            for (let i = 0; i < playerCount; i++) {
                const player = gameConfig.players[i];
                const card = createPlayerCard(i, player);
                container.appendChild(card);
            }
        }

        // Create individual player card
        function createPlayerCard(index, player) {
            const card = document.createElement('div');
            card.className = 'player-setup-card';
            
            // Create model options from available models
            const modelOptions = Object.keys(availableModels).map(key => {
                const model = availableModels[key];
                return `<option value="${model.name}" ${player.model === model.name ? 'selected' : ''}>${key === 'custom' ? 'Custom Model' : key}</option>`;
            }).join('');
            
            card.innerHTML = `
                <div class="player-card-header">
                    <div class="player-number">${index + 1}</div>
                    <h3>Player ${index + 1}</h3>
                </div>
                
                <div class="player-form-grid">
                    <div class="form-group">
                        <label class="form-label">Player Name</label>
                        <input type="text" class="form-input" value="${player.name}" 
                               onchange="updatePlayer(${index}, 'name', this.value)">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Model</label>
                        <select class="form-select" onchange="updatePlayerModel(${index}, this.value)">
                            ${modelOptions}
                        </select>
                        ${player.model === 'custom' || !Object.values(availableModels).some(m => m.name === player.model) ? `
                            <input type="text" class="form-input" style="margin-top: 10px;" 
                                   placeholder="Enter custom model name" value="${player.customModelName || ''}"
                                   onchange="updatePlayer(${index}, 'customModelName', this.value)">
                        ` : ''}
                    </div>
                    
                    <div class="form-group player-form-full">
                        <label class="form-label">
                            <input type="radio" name="instructions-type-${index}" value="personality" 
                                   ${player.useCustomInstructions ? '' : 'checked'} 
                                   onchange="toggleInstructionsType(${index}, false)"> 
                            Use Personality Template
                        </label>
                        <div class="personality-grid" id="personality-grid-${index}" style="${player.useCustomInstructions ? 'display: none;' : ''}">
                            ${Object.keys(personalityTemplates).map(key => `
                                <div class="personality-card ${player.personality === key ? 'selected' : ''}" 
                                     onclick="selectPersonality(${index}, '${key}')">
                                    <div class="personality-title">
                                        <span class="personality-emoji">${personalityTemplates[key].emoji}</span>
                                        ${personalityTemplates[key].title}
                                    </div>
                                    <div class="personality-description">${personalityTemplates[key].description}</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    
                    <div class="form-group player-form-full">
                        <label class="form-label">
                            <input type="radio" name="instructions-type-${index}" value="custom" 
                                   ${player.useCustomInstructions ? 'checked' : ''} 
                                   onchange="toggleInstructionsType(${index}, true)"> 
                            Use Custom Instructions
                        </label>
                        <div id="custom-instructions-${index}" style="${player.useCustomInstructions ? '' : 'display: none;'}">
                            <textarea class="form-textarea" placeholder="Enter custom personality instructions..."
                                      onchange="updatePlayer(${index}, 'customInstructions', this.value)">${player.customInstructions}</textarea>
                            <div class="character-count">${player.customInstructions.length}/500 characters</div>
                        </div>
                    </div>
                    
                    <div class="form-group player-form-full">
                        <label class="form-label">Temperature 
                            <span class="temperature-value">${player.temperature}</span>
                        </label>
                        <div class="slider-container">
                            <input type="range" class="slider" min="0" max="2" step="0.1" 
                                   value="${player.temperature}" 
                                   onchange="updatePlayer(${index}, 'temperature', parseFloat(this.value))">
                            <div class="slider-labels">
                                <span>Conservative (0.0)</span>
                                <span>Balanced (1.0)</span>
                                <span>Creative (2.0)</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            return card;
        }

        // Update player configuration
        function updatePlayer(index, field, value) {
            gameConfig.players[index][field] = value;
            
            // Update temperature display
            if (field === 'temperature') {
                const tempDisplay = document.querySelector(`#players-container .player-setup-card:nth-child(${index + 1}) .temperature-value`);
                if (tempDisplay) {
                    tempDisplay.textContent = value;
                }
            }
            
            // Update character count for custom instructions
            if (field === 'customInstructions') {
                const charCount = document.querySelector(`#players-container .player-setup-card:nth-child(${index + 1}) .character-count`);
                if (charCount) {
                    charCount.textContent = `${value.length}/500 characters`;
                }
            }
        }

        // Update player model and handle custom model input
        function updatePlayerModel(index, selectedValue) {
            const player = gameConfig.players[index];
            
            // Check if this is a custom model or predefined
            const isCustom = selectedValue === 'custom' || !Object.values(availableModels).some(m => m.name === selectedValue);
            
            if (isCustom) {
                player.model = 'custom';
                player.customModelName = selectedValue === 'custom' ? '' : selectedValue;
            } else {
                player.model = selectedValue;
                player.customModelName = '';
                
                // Update temperature to model default
                const modelKey = Object.keys(availableModels).find(key => availableModels[key].name === selectedValue);
                if (modelKey && availableModels[modelKey].defaultTemp) {
                    player.temperature = availableModels[modelKey].defaultTemp;
                }
            }
            
            // Regenerate the card to show/hide custom input
            generatePlayerCards();
        }

        // Toggle between personality templates and custom instructions
        function toggleInstructionsType(index, useCustom) {
            const player = gameConfig.players[index];
            player.useCustomInstructions = useCustom;
            
            const personalityGrid = document.getElementById(`personality-grid-${index}`);
            const customInstructions = document.getElementById(`custom-instructions-${index}`);
            
            if (useCustom) {
                personalityGrid.style.display = 'none';
                customInstructions.style.display = 'block';
                // If switching to custom and no custom instructions, use template as starting point
                if (!player.customInstructions && player.personality) {
                    player.customInstructions = personalityTemplates[player.personality].instructions;
                    const textarea = customInstructions.querySelector('textarea');
                    if (textarea) {
                        textarea.value = player.customInstructions;
                    }
                }
            } else {
                personalityGrid.style.display = 'grid';
                customInstructions.style.display = 'none';
                // When switching back to templates, update instructions from selected personality
                if (player.personality) {
                    player.customInstructions = personalityTemplates[player.personality].instructions;
                }
            }
        }

        // Select personality for a player
        function selectPersonality(playerIndex, personality) {
            gameConfig.players[playerIndex].personality = personality;
            
            // Update custom instructions with template
            const template = personalityTemplates[personality];
            if (template && !gameConfig.players[playerIndex].customInstructions) {
                gameConfig.players[playerIndex].customInstructions = template.instructions;
            }
            
            // Regenerate the player card to reflect changes
            generatePlayerCards();
        }

        // Navigation functions
        function nextStep() {
            if (currentStep === 1) {
                // Update global config
                gameConfig.gameName = document.getElementById('game-name').value;
            } else if (currentStep === 2) {
                if (!validateStep2()) return;
            }
            
            if (currentStep < 3) {
                currentStep++;
                showStep(currentStep);
            } else {
                // Launch game
                launchGame();
            }
        }

        function previousStep() {
            if (currentStep > 1) {
                currentStep--;
                showStep(currentStep);
            }
        }

        function showStep(step) {
            // Hide all steps
            document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
            
            // Show current step
            document.getElementById(`step-${step}`).classList.add('active');
            
            // Update progress and navigation
            updateProgressBar();
            updateNavigation();
            
            // Generate content for specific steps
            if (step === 3) {
                generateReviewContent();
            }
        }

        function updateNavigation() {
            const prevBtn = document.getElementById('prev-btn');
            const nextBtn = document.getElementById('next-btn');
            
            prevBtn.style.display = currentStep > 1 ? 'block' : 'none';
            
            if (currentStep === 3) {
                nextBtn.textContent = '🚀 Launch Game';
                nextBtn.className = 'btn btn-success';
            } else {
                nextBtn.textContent = 'Next →';
                nextBtn.className = 'btn btn-primary';
            }
        }

        // Validation functions
        function validateStep2() {
            // Check for duplicate names
            const names = gameConfig.players.map(p => p.name.trim().toLowerCase());
            const duplicates = names.filter((name, index) => names.indexOf(name) !== index);
            
            if (duplicates.length > 0) {
                showError('Player names must be unique');
                return false;
            }
            
            // Check for empty names
            const emptyNames = gameConfig.players.some(p => !p.name.trim());
            if (emptyNames) {
                showError('All players must have names');
                return false;
            }
            
            hideError();
            return true;
        }

        // Generate review content
        function generateReviewContent() {
            const summary = document.getElementById('game-summary');
            const reviewGrid = document.getElementById('review-grid');
            
            // Game summary
            summary.innerHTML = `
                <div class="review-card">
                    <h3>Game Details</h3>
                    <div class="review-detail">
                        <span class="review-label">Game Name:</span>
                        <span class="review-value">${gameConfig.gameName || 'Auto-generated'}</span>
                    </div>
                    <div class="review-detail">
                        <span class="review-label">Players:</span>
                        <span class="review-value">${playerCount}</span>
                    </div>
                    <div class="review-detail">
                        <span class="review-label">Configuration:</span>
                        <span class="review-value">Server-side API credentials</span>
                    </div>
                </div>
            `;
            
            // Player review cards
            reviewGrid.innerHTML = gameConfig.players.map((player, index) => {
                // Get model display name
                let modelDisplay = player.model;
                if (player.model === 'custom' && player.customModelName) {
                    modelDisplay = player.customModelName;
                } else {
                    // Find the display name from available models
                    const modelKey = Object.keys(availableModels).find(key => availableModels[key].name === player.model);
                    if (modelKey && modelKey !== 'custom') {
                        modelDisplay = modelKey;
                    }
                }
                
                return `
                    <div class="review-card">
                        <div class="review-player-name">
                            <div class="review-player-number">${index + 1}</div>
                            ${player.name}
                        </div>
                        <div class="review-detail">
                            <span class="review-label">Model:</span>
                            <span class="review-value">${modelDisplay}</span>
                        </div>
                        <div class="review-detail">
                            <span class="review-label">Personality:</span>
                            <span class="review-value">${personalityTemplates[player.personality].emoji} ${personalityTemplates[player.personality].title}</span>
                        </div>
                        <div class="review-detail">
                            <span class="review-label">Temperature:</span>
                            <span class="review-value">${player.temperature}</span>
                        </div>
                        <div class="review-detail">
                            <span class="review-label">Instructions:</span>
                            <span class="review-value">${player.useCustomInstructions ? 'Custom' : 'Template'}</span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Quick presets
        function showQuickPresets() {
            const presets = document.getElementById('quick-presets');
            presets.style.display = presets.style.display === 'none' ? 'grid' : 'none';
        }

        function loadQuickPreset(presetType) {
            const presets = {
                balanced: {
                    playerCount: 4,
                    players: [
                        { name: 'Alexander', personality: 'aggressive', model: 'gpt-4' },
                        { name: 'Diplomat', personality: 'diplomatic', model: 'gpt-3.5-turbo' },
                        { name: 'Guardian', personality: 'defensive', model: 'gpt-4-turbo' },
                        { name: 'Strategist', personality: 'balanced', model: 'gpt-4o-mini' }
                    ]
                },
                aggressive: {
                    playerCount: 6,
                    players: [
                        { name: 'Warlord', personality: 'aggressive', model: 'gpt-4' },
                        { name: 'Conqueror', personality: 'aggressive', model: 'gpt-4-turbo' },
                        { name: 'Raider', personality: 'opportunistic', model: 'gpt-3.5-turbo' },
                        { name: 'Berserker', personality: 'aggressive', model: 'gpt-4o' },
                        { name: 'Marauder', personality: 'aggressive', model: 'gpt-4o-mini' },
                        { name: 'Invader', personality: 'opportunistic', model: 'gpt-3.5-turbo' }
                    ]
                },
                diplomatic: {
                    playerCount: 4,
                    players: [
                        { name: 'Ambassador', personality: 'diplomatic', model: 'gpt-4' },
                        { name: 'Mediator', personality: 'diplomatic', model: 'gpt-4-turbo' },
                        { name: 'Negotiator', personality: 'balanced', model: 'gpt-3.5-turbo' },
                        { name: 'Peacekeeper', personality: 'defensive', model: 'gpt-4o-mini' }
                    ]
                },
                mixed: {
                    playerCount: 5,
                    players: [
                        { name: 'Caesar', personality: 'aggressive', model: 'gpt-4' },
                        { name: 'Bismarck', personality: 'diplomatic', model: 'gpt-4-turbo' },
                        { name: 'Maginot', personality: 'defensive', model: 'gpt-3.5-turbo' },
                        { name: 'Rockefeller', personality: 'economic', model: 'gpt-4o' },
                        { name: 'Machiavelli', personality: 'opportunistic', model: 'gpt-4o-mini' }
                    ]
                }
            };
            
            const preset = presets[presetType];
            if (preset) {
                playerCount = preset.playerCount;
                selectPlayerCount(playerCount);
                
                // Update player configurations
                gameConfig.players = preset.players.map((p, index) => {
                    // Get default temperature for the model
                    let defaultTemp = 0.8;
                    const modelKey = Object.keys(availableModels).find(key => key === p.model);
                    if (modelKey && availableModels[modelKey].defaultTemp) {
                        defaultTemp = availableModels[modelKey].defaultTemp;
                    }
                    
                    return {
                        name: p.name,
                        model: p.model,
                        temperature: defaultTemp,
                        personality: p.personality,
                        customInstructions: personalityTemplates[p.personality].instructions,
                        useCustomInstructions: false,
                        customModelName: ''
                    };
                });
                
                generatePlayerCards();
                showSuccess(`Loaded ${presetType} preset with ${preset.playerCount} players`);
                document.getElementById('quick-presets').style.display = 'none';
            }
        }

        // Configuration management
        async function saveConfiguration() {
            try {
                const configName = gameConfig.gameName || `Game-${new Date().toISOString().split('T')[0]}`;
                
                const config = {
                    gameName: gameConfig.gameName,
                    playerCount: playerCount,
                    players: gameConfig.players.map(p => ({
                        name: p.name,
                        model: p.model,
                        temperature: p.temperature,
                        personality: p.personality,
                        customInstructions: p.customInstructions,
                        useCustomInstructions: p.useCustomInstructions
                        // Don't save API keys for security
                    }))
                };
                
                const response = await fetch('/api/configs', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        name: configName,
                        configuration: config
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    showSuccess(`Configuration saved as '${result.filename}'`);
                } else {
                    const error = await response.text();
                    throw new Error(`HTTP ${response.status}: ${error}`);
                }
                
            } catch (error) {
                showError('Failed to save configuration: ' + error.message);
            }
        }

        async function loadConfiguration() {
            try {
                // First, get list of available configurations
                const response = await fetch('/api/configs');
                if (!response.ok) {
                    throw new Error('Failed to load configuration list');
                }
                
                const data = await response.json();
                const configurations = data.configurations;
                
                if (configurations.length === 0) {
                    showError('No saved configurations found');
                    return;
                }
                
                // Create a selection dialog
                const configList = configurations.map(config => 
                    `<option value="${config.filename}">${config.name} (${config.playerCount} players)</option>`
                ).join('');
                
                const selectHtml = `
                    <div style="margin: 20px 0;">
                        <label for="config-select" style="display: block; margin-bottom: 10px; font-weight: 600;">Select Configuration:</label>
                        <select id="config-select" style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px;">
                            ${configList}
                        </select>
                        <div style="margin-top: 15px; text-align: right;">
                            <button onclick="cancelConfigLoad()" style="margin-right: 10px; padding: 8px 16px; background: #95a5a6; color: white; border: none; border-radius: 5px; cursor: pointer;">Cancel</button>
                            <button onclick="confirmConfigLoad()" style="padding: 8px 16px; background: #3498db; color: white; border: none; border-radius: 5px; cursor: pointer;">Load</button>
                        </div>
                    </div>
                `;
                
                // Show the selection dialog
                const errorDiv = document.getElementById('error-message');
                errorDiv.innerHTML = selectHtml;
                errorDiv.style.display = 'block';
                errorDiv.style.background = '#f8f9fa';
                errorDiv.style.color = '#333';
                errorDiv.style.border = '2px solid #3498db';
                
            } catch (error) {
                showError('Failed to load configurations: ' + error.message);
            }
        }
        
        function cancelConfigLoad() {
            hideError();
        }
        
        async function confirmConfigLoad() {
            try {
                const select = document.getElementById('config-select');
                const filename = select.value;
                
                if (!filename) {
                    showError('Please select a configuration');
                    return;
                }
                
                // Load the selected configuration
                const response = await fetch(`/api/configs/${filename}`);
                if (!response.ok) {
                    throw new Error('Failed to load configuration');
                }
                
                const data = await response.json();
                const config = data.configuration;
                
                // Validate configuration
                if (!config.players || !Array.isArray(config.players)) {
                    throw new Error('Invalid configuration format');
                }
                
                // Load configuration
                document.getElementById('game-name').value = config.gameName || '';
                gameConfig.gameName = config.gameName || '';
                playerCount = config.playerCount || config.players.length;
                
                // Update player count selection
                document.querySelectorAll('.player-count-option').forEach(option => {
                    option.classList.remove('selected');
                });
                const selectedOption = document.querySelector(`.player-count-option:nth-child(${playerCount - 1})`);
                if (selectedOption) {
                    selectedOption.classList.add('selected');
                }
                
                gameConfig.players = config.players.map(p => ({
                    name: p.name || 'Player',
                    model: p.model || Object.values(availableModels)[0]?.name || 'gpt-3.5-turbo',
                    temperature: p.temperature || 0.8,
                    personality: p.personality || 'balanced',
                    customInstructions: p.customInstructions || personalityTemplates[p.personality || 'balanced'].instructions,
                    useCustomInstructions: p.useCustomInstructions || false,
                    customModelName: ''
                }));
                
                generatePlayerCards();
                hideError();
                showSuccess(`Configuration '${config.gameName || filename}' loaded successfully`);
                
            } catch (error) {
                showError('Failed to load configuration: ' + error.message);
            }
        }

        // Game launch
        async function launchGame() {
            try {
                showLoading();
                
                // Prepare player configurations
                const playerConfigs = gameConfig.players.map(player => {
                    // Determine the actual model name to use
                    let modelName = player.model;
                    if (player.model === 'custom' && player.customModelName) {
                        modelName = player.customModelName;
                    } else if (player.model !== 'custom') {
                        // Find the model key that matches the display name
                        const modelKey = Object.keys(availableModels).find(key => availableModels[key].name === player.model);
                        if (modelKey && modelKey !== 'custom') {
                            // Use the actual model name from the config, not the key
                            modelName = availableModels[modelKey].name;
                        }
                    }
                    
                    return {
                        name: player.name,
                        model_name: modelName,
                        temperature: player.temperature,
                        custom_instructions: player.customInstructions || personalityTemplates[player.personality].instructions,
                        api_key: "",  // Empty string allows server to use environment default
                        base_url: ""  // Empty string allows server to use environment default
                    };
                });
                
                // Create game via API
                const response = await fetch('/api/games', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        num_players: playerCount,
                        game_name: gameConfig.gameName,
                        player_configs: playerConfigs
                    })
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }
                
                const result = await response.json();
                
                if (result.success && result.game_id) {
                    showSuccess('Game created successfully! Redirecting to dashboard...');
                    
                    // Check for dashboard mode preference
                    const dashboardMode = localStorage.getItem('preferred_dashboard_mode') || 'standard';
                    const dashboardFile = dashboardMode === 'briefing' ? 'risk_dashboard_briefing.html' : 'risk_dashboard.html';
                    
                    // Redirect to dashboard with game ID
                    setTimeout(() => {
                        window.location.href = `${dashboardFile}?game_id=${result.game_id}`;
                    }, 2000);
                } else {
                    throw new Error(result.message || 'Failed to create game');
                }
                
            } catch (error) {
                hideLoading();
                showError('Failed to create game: ' + error.message);
                console.error('Game creation error:', error);
            }
        }

        // Utility functions
        function showError(message) {
            const errorDiv = document.getElementById('error-message');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            hideSuccess();
        }

        function hideError() {
            document.getElementById('error-message').style.display = 'none';
        }

        function showSuccess(message) {
            const successDiv = document.getElementById('success-message');
            successDiv.textContent = message;
            successDiv.style.display = 'block';
            hideError();
        }

        function hideSuccess() {
            document.getElementById('success-message').style.display = 'none';
        }

        function showLoading() {
            document.getElementById('loading').style.display = 'block';
            document.getElementById('wizard-actions').style.display = 'none';
        }

        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('wizard-actions').style.display = 'flex';
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            initializeWizard();
            updateNavigation();
        });
    </script>
</body>
</html>
