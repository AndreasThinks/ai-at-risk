<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Risk Game Admin Panel</title>
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }
        
        /* Login Form */
        .login-form {
            padding: 40px;
            text-align: center;
            max-width: 400px;
            margin: 0 auto;
        }
        
        .login-form h2 {
            margin-bottom: 30px;
            color: #2c3e50;
        }
        
        .form-group {
            margin-bottom: 20px;
            text-align: left;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }
        
        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: transform 0.3s, box-shadow 0.3s;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #27ae60 0%, #229954 100%);
        }
        
        .btn-warning {
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
        }
        
        .btn-small {
            padding: 8px 16px;
            font-size: 14px;
            margin: 2px;
        }
        
        /* Admin Panel */
        .admin-panel {
            display: none;
        }
        
        .nav-tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 2px solid #dee2e6;
        }
        
        .nav-tab {
            flex: 1;
            padding: 20px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            color: #6c757d;
            transition: all 0.3s;
        }
        
        .nav-tab.active {
            background: white;
            color: #667eea;
            border-bottom: 3px solid #667eea;
        }
        
        .nav-tab:hover {
            background: #e9ecef;
        }
        
        .tab-content {
            padding: 30px;
        }
        
        .tab-pane {
            display: none;
        }
        
        .tab-pane.active {
            display: block;
        }
        
        /* Cards */
        .card {
            background: white;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            overflow: hidden;
        }
        
        .card-header {
            background: #f8f9fa;
            padding: 20px;
            border-bottom: 1px solid #dee2e6;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .card-body {
            padding: 20px;
        }
        
        /* Tables */
        .table-container {
            overflow-x: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #495057;
        }
        
        tr:hover {
            background: #f8f9fa;
        }
        
        /* Modals */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
        }
        
        .modal-content {
            background: white;
            margin: 5% auto;
            padding: 0;
            border-radius: 10px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-header {
            padding: 20px;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-header h3 {
            margin: 0;
            color: #495057;
        }
        
        .close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #6c757d;
        }
        
        .close:hover {
            color: #495057;
        }
        
        .modal-body {
            padding: 20px;
        }
        
        .modal-footer {
            padding: 20px;
            background: #f8f9fa;
            border-top: 1px solid #dee2e6;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        
        /* Alerts */
        .alert {
            padding: 15px;
            margin: 20px 0;
            border-radius: 8px;
            border-left: 5px solid;
        }
        
        .alert-success {
            background: #d4edda;
            border-color: #27ae60;
            color: #155724;
        }
        
        .alert-danger {
            background: #f8d7da;
            border-color: #e74c3c;
            color: #721c24;
        }
        
        .alert-warning {
            background: #fff3cd;
            border-color: #f39c12;
            color: #856404;
        }
        
        .alert-info {
            background: #d1ecf1;
            border-color: #17a2b8;
            color: #0c5460;
        }
        
        /* Stats Cards */
        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 10px;
            text-align: center;
        }
        
        .stat-card h3 {
            font-size: 2em;
            margin-bottom: 10px;
        }
        
        .stat-card p {
            font-size: 1.1em;
            opacity: 0.9;
        }
        
        /* Loading */
        .loading {
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .container {
                margin: 10px;
                border-radius: 0;
            }
            
            .header {
                padding: 20px;
            }
            
            .header h1 {
                font-size: 1.8em;
            }
            
            .nav-tab {
                padding: 15px 10px;
                font-size: 14px;
            }
            
            .tab-content {
                padding: 20px;
            }
            
            .modal-content {
                margin: 10% auto;
                width: 95%;
            }
            
            .stats-container {
                grid-template-columns: 1fr;
            }
        }
        
        .hidden {
            display: none !important;
        }
        
        /* Action buttons */
        .actions {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }
        
        /* Character/Model specific styles */
        .personality-text {
            max-width: 300px;
            max-height: 100px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .personality-text:hover {
            white-space: normal;
            overflow: visible;
            background: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: relative;
            z-index: 10;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéØ Risk Game Admin Panel</h1>
            <p>Manage characters, models, and tournament settings</p>
        </div>
        
        <!-- Login Form -->
        <div id="loginForm" class="login-form">
            <h2>Admin Authentication</h2>
            <form id="authForm">
                <div class="form-group">
                    <label for="password">Admin Password:</label>
                    <input type="password" id="password" name="password" required>
                </div>
                <button type="submit" class="btn">Login</button>
            </form>
            <div id="loginError" class="alert alert-danger hidden"></div>
        </div>
        
        <!-- Admin Panel -->
        <div id="adminPanel" class="admin-panel">
            <div class="nav-tabs">
                <button class="nav-tab active" onclick="showTab('dashboard')">üìä Dashboard</button>
                <button class="nav-tab" onclick="showTab('characters')">üë• Characters</button>
                <button class="nav-tab" onclick="showTab('models')">ü§ñ Models</button>
                <button class="nav-tab" onclick="showTab('games')">üéÆ Games</button>
                <button class="nav-tab" onclick="showTab('tournament')">üèÜ Tournament</button>
            </div>
            
            <div class="tab-content">
                <!-- Dashboard Tab -->
                <div id="dashboard" class="tab-pane active">
                    <div id="statsContainer" class="stats-container">
                        <!-- Stats will be loaded here -->
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <h3>Quick Actions</h3>
                        </div>
                        <div class="card-body">
                            <button class="btn btn-warning" onclick="syncModels()">üîÑ Sync Models from Environment</button>
                            <button class="btn btn-danger" onclick="resetAllStats()">üìä Reset All Character Stats</button>
                            <button class="btn btn-warning" onclick="clearVotes()">üó≥Ô∏è Clear Tournament Votes</button>
                        </div>
                    </div>
                </div>
                
                <!-- Characters Tab -->
                <div id="characters" class="tab-pane">
                    <div class="card">
                        <div class="card-header">
                            <h3>Character Management</h3>
                            <div>
                                <button class="btn" onclick="refreshCharacters()">üîÑ Refresh</button>
                                <button class="btn btn-danger" onclick="bulkDeleteSelected()">üóëÔ∏è Delete Selected</button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div id="charactersLoading" class="loading">
                                <div class="spinner"></div>
                                <p>Loading characters...</p>
                            </div>
                            <div id="charactersTable" class="table-container hidden">
                                <!-- Table will be loaded here -->
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Models Tab -->
                <div id="models" class="tab-pane">
                    <div class="card">
                        <div class="card-header">
                            <h3>Model Management</h3>
                            <div>
                                <button class="btn" onclick="showAddModelModal()">‚ûï Add Model</button>
                                <button class="btn" onclick="refreshModels()">üîÑ Refresh</button>
                                <button class="btn btn-warning" onclick="syncModels()">üîÑ Sync with Environment</button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div id="modelsLoading" class="loading">
                                <div class="spinner"></div>
                                <p>Loading models...</p>
                            </div>
                            <div id="modelsTable" class="table-container hidden">
                                <!-- Table will be loaded here -->
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Games Tab -->
                <div id="games" class="tab-pane">
                    <div class="card">
                        <div class="card-header">
                            <h3>Active Games Management</h3>
                            <button class="btn" onclick="refreshGames()">üîÑ Refresh</button>
                        </div>
                        <div class="card-body">
                            <div id="gamesLoading" class="loading">
                                <div class="spinner"></div>
                                <p>Loading active games...</p>
                            </div>
                            <div id="gamesTable" class="table-container hidden">
                                <!-- Table will be loaded here -->
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Tournament Tab -->
                <div id="tournament" class="tab-pane">
                    <div class="card">
                        <div class="card-header">
                            <h3>Tournament Status</h3>
                            <button class="btn" onclick="refreshTournamentStatus()">üîÑ Refresh</button>
                        </div>
                        <div class="card-body">
                            <div id="tournamentStatus" class="loading">
                                <div class="spinner"></div>
                                <p>Loading tournament status...</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <h3>Tournament Controls</h3>
                        </div>
                        <div class="card-body">
                            <button class="btn btn-success" id="restart-match-btn" onclick="restartTournamentMatch()" style="display: none;">üîÑ Restart Match</button>
                            <button class="btn btn-warning" onclick="forceAdvanceTournamentPhase()">üöÄ Force Advance Phase</button>
                            <button class="btn btn-warning" onclick="clearVotes()">üó≥Ô∏è Clear All Votes</button>
                            <button class="btn btn-danger" onclick="resetAllStats()">üìä Reset All Statistics</button>
                            <p style="margin-top: 20px; color: #6c757d;">
                                <strong>Restart Match:</strong> Resume a tournament paused due to token exhaustion (only available during TOKEN_EXHAUSTED phase).<br>
                                <strong>Force Advance Phase:</strong> Manually advance the tournament to the next phase (submission ‚Üí voting ‚Üí game ‚Üí end screen).<br>
                                <strong>Clear Votes:</strong> Reset the voting phase by clearing all votes.<br>
                                <strong>Reset Statistics:</strong> Clear all character win/loss records.
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Character Edit Modal -->
    <div id="characterModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="characterModalTitle">Edit Character</h3>
                <button class="close" onclick="closeModal('characterModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="characterForm">
                    <input type="hidden" id="characterId">
                    <div class="form-group">
                        <label for="characterName">Name:</label>
                        <input type="text" id="characterName" required>
                    </div>
                    <div class="form-group">
                        <label for="characterModel">Model:</label>
                        <select id="characterModel" required>
                            <option value="">Select a model...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="characterTemperature">Temperature:</label>
                        <input type="number" id="characterTemperature" min="0" max="2" step="0.1" required>
                    </div>
                    <div class="form-group">
                        <label for="characterPersonality">Personality:</label>
                        <textarea id="characterPersonality" rows="4" required></textarea>
                    </div>
                    <div class="form-group">
                        <label for="characterInstructions">Custom Instructions:</label>
                        <textarea id="characterInstructions" rows="4"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="characterSubmittedBy">Submitted By:</label>
                        <input type="text" id="characterSubmittedBy">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeModal('characterModal')">Cancel</button>
                <button class="btn btn-success" onclick="saveCharacter()">Save</button>
            </div>
        </div>
    </div>
    
    <!-- Model Add/Edit Modal -->
    <div id="modelModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modelModalTitle">Add Model</h3>
                <button class="close" onclick="closeModal('modelModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="modelForm">
                    <input type="hidden" id="modelId">
                    <div class="form-group">
                        <label for="modelName">Model Name:</label>
                        <input type="text" id="modelName" required placeholder="e.g., gpt-4">
                    </div>
                    <div class="form-group">
                        <label for="modelDisplayName">Display Name:</label>
                        <input type="text" id="modelDisplayName" required placeholder="e.g., GPT-4">
                    </div>
                    <div class="form-group">
                        <label for="modelTemperature">Default Temperature:</label>
                        <input type="number" id="modelTemperature" min="0" max="2" step="0.1" value="0.7" required>
                    </div>
                    <div class="form-group">
                        <label for="modelDescription">Description:</label>
                        <textarea id="modelDescription" rows="3" placeholder="Describe this model..."></textarea>
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="modelActive" checked> Active
                        </label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeModal('modelModal')">Cancel</button>
                <button class="btn btn-success" onclick="saveModel()">Save</button>
            </div>
        </div>
    </div>
    
    <!-- Confirmation Modal -->
    <div id="confirmModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Confirm Action</h3>
                <button class="close" onclick="closeModal('confirmModal')">&times;</button>
            </div>
            <div class="modal-body">
                <p id="confirmMessage">Are you sure?</p>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeModal('confirmModal')">Cancel</button>
                <button class="btn btn-danger" id="confirmButton">Confirm</button>
            </div>
        </div>
    </div>

    <script>
        let adminPassword = '';
        let charactersData = [];
        let modelsData = [];
        
        // API Configuration
        const API_BASE = '/api';
        
        // Authentication
        document.getElementById('authForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const password = document.getElementById('password').value;
            
            try {
                const response = await fetch(`${API_BASE}/admin/auth`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password })
                });
                
                if (response.ok) {
                    adminPassword = password;
                    document.getElementById('loginForm').style.display = 'none';
                    document.getElementById('adminPanel').style.display = 'block';
                    loadDashboard();
                } else {
                    showError('loginError', 'Invalid password');
                }
            } catch (error) {
                showError('loginError', 'Authentication failed: ' + error.message);
            }
        });
        
        // Tab Management
        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-pane').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
            
            // Load data for the tab
            switch(tabName) {
                case 'dashboard':
                    loadDashboard();
                    break;
                case 'characters':
                    loadCharacters();
                    break;
                case 'models':
                    loadModels();
                    break;
                case 'games':
                    loadGames();
                    break;
                case 'tournament':
                    loadTournamentStatus();
                    break;
            }
        }
        
        // Dashboard
        async function loadDashboard() {
            try {
                // Load characters and models data for stats
                await Promise.all([loadCharacters(false), loadModels(false)]);
                
                const characterCount = charactersData.length;
                const modelCount = modelsData.length;
                const activeModels = modelsData.filter(m => m.is_active).length;
                const totalGames = charactersData.reduce((sum, char) => sum + (char.times_played || 0), 0);
                
                document.getElementById('statsContainer').innerHTML = `
                    <div class="stat-card">
                        <h3>${characterCount}</h3>
                        <p>Total Characters</p>
                    </div>
                    <div class="stat-card">
                        <h3>${modelCount}</h3>
                        <p>Total Models</p>
                    </div>
                    <div class="stat-card">
                        <h3>${activeModels}</h3>
                        <p>Active Models</p>
                    </div>
                    <div class="stat-card">
                        <h3>${totalGames}</h3>
                        <p>Games Played</p>
                    </div>
                `;
            } catch (error) {
                console.error('Failed to load dashboard:', error);
            }
        }
        
        // Characters Management
        async function loadCharacters(showLoading = true) {
            if (showLoading) {
                document.getElementById('charactersLoading').classList.remove('hidden');
                document.getElementById('charactersTable').classList.add('hidden');
            }
            
            try {
                const response = await fetch(`${API_BASE}/admin/characters?password=${encodeURIComponent(adminPassword)}`);
                const data = await response.json();
                
                if (response.ok) {
                    charactersData = data.characters;
                    displayCharacters();
                } else {
                    throw new Error(data.detail || 'Failed to load characters');
                }
            } catch (error) {
                showAlert('danger', 'Failed to load characters: ' + error.message);
            } finally {
                if (showLoading) {
                    document.getElementById('charactersLoading').classList.add('hidden');
                    document.getElementById('charactersTable').classList.remove('hidden');
                }
            }
        }
        
        function displayCharacters() {
            const tableHtml = `
                <table>
                    <thead>
                        <tr>
                            <th><input type="checkbox" onchange="toggleAllCharacters(this)"></th>
                            <th>ID</th>
                            <th>Name</th>
                            <th>Model</th>
                            <th>Temperature</th>
                            <th>Games</th>
                            <th>Wins</th>
                            <th>Win Rate</th>
                            <th>Submitted By</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${charactersData.map(char => `
                            <tr>
                                <td><input type="checkbox" value="${char.id}" class="character-checkbox"></td>
                                <td>${char.id}</td>
                                <td>${char.name}</td>
                                <td>${char.model_name}</td>
                                <td>${char.temperature}</td>
                                <td>${char.times_played || 0}</td>
                                <td>${char.wins || 0}</td>
                                <td>${char.times_played > 0 ? Math.round((char.wins / char.times_played) * 100) : 0}%</td>
                                <td>${char.submitted_by}</td>
                                <td class="actions">
                                    <button class="btn btn-small" onclick="editCharacter(${char.id})">‚úèÔ∏è Edit</button>
                                    <button class="btn btn-small btn-danger" onclick="deleteCharacter(${char.id})">üóëÔ∏è Delete</button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            
            document.getElementById('charactersTable').innerHTML = tableHtml;
        }
        
        function toggleAllCharacters(checkbox) {
            const checkboxes = document.querySelectorAll('.character-checkbox');
            checkboxes.forEach(cb => cb.checked = checkbox.checked);
        }
        
        function refreshCharacters() {
            loadCharacters();
        }
        
        async function editCharacter(characterId) {
            const character = charactersData.find(c => c.id === characterId);
            if (!character) return;
            
            // Load models for dropdown
            await loadModels(false);
            
            // Populate model dropdown
            const modelSelect = document.getElementById('characterModel');
            modelSelect.innerHTML = '<option value="">Select a model...</option>' +
                modelsData.map(model => `<option value="${model.name}">${model.display_name}</option>`).join('');
            
            // Populate form
            document.getElementById('characterId').value = character.id;
            document.getElementById('characterName').value = character.name;
            document.getElementById('characterModel').value = character.model_name;
            document.getElementById('characterTemperature').value = character.temperature;
            document.getElementById('characterPersonality').value = character.personality;
            document.getElementById('characterInstructions').value = character.custom_instructions;
            document.getElementById('characterSubmittedBy').value = character.submitted_by;
            
            document.getElementById('characterModalTitle').textContent = 'Edit Character';
            document.getElementById('characterModal').style.display = 'block';
        }
        
        async function saveCharacter() {
            const id = document.getElementById('characterId').value;
            const data = {
                password: adminPassword,
                name: document.getElementById('characterName').value,
                model_name: document.getElementById('characterModel').value,
                temperature: parseFloat(document.getElementById('characterTemperature').value),
                personality: document.getElementById('characterPersonality').value,
                custom_instructions: document.getElementById('characterInstructions').value,
                submitted_by: document.getElementById('characterSubmittedBy').value
            };
            
            try {
                const response = await fetch(`${API_BASE}/admin/characters/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showAlert('success', result.message);
                    closeModal('characterModal');
                    loadCharacters();
                } else {
                    throw new Error(result.detail || 'Failed to save character');
                }
            } catch (error) {
                showAlert('danger', 'Failed to save character: ' + error.message);
            }
        }
        
        async function deleteCharacter(characterId) {
            const character = charactersData.find(c => c.id === characterId);
            if (!character) return;
            
            showConfirmModal(
                `Are you sure you want to delete character "${character.name}"?`,
                async () => {
                    try {
                        const response = await fetch(`${API_BASE}/admin/characters/${characterId}?password=${encodeURIComponent(adminPassword)}`, {
                            method: 'DELETE'
                        });
                        
                        const result = await response.json();
                        
                        if (response.ok) {
                            showAlert('success', result.message);
                            loadCharacters();
                        } else {
                            throw new Error(result.detail || 'Failed to delete character');
                        }
                    } catch (error) {
                        showAlert('danger', 'Failed to delete character: ' + error.message);
                    }
                }
            );
        }
        
        async function bulkDeleteSelected() {
            const checkboxes = document.querySelectorAll('.character-checkbox:checked');
            const characterIds = Array.from(checkboxes).map(cb => parseInt(cb.value));
            
            if (characterIds.length === 0) {
                showAlert('warning', 'No characters selected');
                return;
            }
            
            showConfirmModal(
                `Are you sure you want to delete ${characterIds.length} selected characters?`,
                async () => {
                    try {
                        const response = await fetch(`${API_BASE}/admin/characters/bulk-delete`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                password: adminPassword,
                                character_ids: characterIds
                            })
                        });
                        
                        const result = await response.json();
                        
                        if (response.ok) {
                            showAlert('success', result.message);
                            loadCharacters();
                        } else {
                            throw new Error(result.detail || 'Failed to delete characters');
                        }
                    } catch (error) {
                        showAlert('danger', 'Failed to delete characters: ' + error.message);
                    }
                }
            );
        }
        
        // Models Management
        async function loadModels(showLoading = true) {
            if (showLoading) {
                document.getElementById('modelsLoading').classList.remove('hidden');
                document.getElementById('modelsTable').classList.add('hidden');
            }
            
            try {
                const response = await fetch(`${API_BASE}/admin/models?password=${encodeURIComponent(adminPassword)}`);
                const data = await response.json();
                
                if (response.ok) {
                    modelsData = data.models;
                    displayModels();
                } else {
                    throw new Error(data.detail || 'Failed to load models');
                }
            } catch (error) {
                showAlert('danger', 'Failed to load models: ' + error.message);
            } finally {
                if (showLoading) {
                    document.getElementById('modelsLoading').classList.add('hidden');
                    document.getElementById('modelsTable').classList.remove('hidden');
                }
            }
        }
        
        function displayModels() {
            const tableHtml = `
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Display Name</th>
                            <th>Model Name</th>
                            <th>Temperature</th>
                            <th>Description</th>
                            <th>Active</th>
                            <th>Characters</th>
                            <th>Games</th>
                            <th>Win Rate</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${modelsData.map(model => `
                            <tr>
                                <td>${model.id}</td>
                                <td>${model.display_name}</td>
                                <td>${model.name}</td>
                                <td>${model.default_temperature}</td>
                                <td class="personality-text">${model.description}</td>
                                <td>${model.is_active ? '‚úÖ Yes' : '‚ùå No'}</td>
                                <td>${model.character_count || 0}</td>
                                <td>${model.total_games || 0}</td>
                                <td>${model.win_rate || 0}%</td>
                                <td class="actions">
                                    <button class="btn btn-small" onclick="editModel(${model.id})">‚úèÔ∏è Edit</button>
                                    <button class="btn btn-small btn-warning" onclick="toggleModel(${model.id})">${model.is_active ? 'üîá Disable' : 'üîä Enable'}</button>
                                    <button class="btn btn-small btn-danger" onclick="deleteModel(${model.id})">üóëÔ∏è Delete</button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            
            document.getElementById('modelsTable').innerHTML = tableHtml;
        }
        
        function showAddModelModal() {
            // Clear form
            document.getElementById('modelForm').reset();
            document.getElementById('modelId').value = '';
            document.getElementById('modelModalTitle').textContent = 'Add Model';
            document.getElementById('modelModal').style.display = 'block';
        }
        
        function refreshModels() {
            loadModels();
        }
        
        async function editModel(modelId) {
            const model = modelsData.find(m => m.id === modelId);
            if (!model) return;
            
            // Populate form
            document.getElementById('modelId').value = model.id;
            document.getElementById('modelName').value = model.name;
            document.getElementById('modelDisplayName').value = model.display_name;
            document.getElementById('modelTemperature').value = model.default_temperature;
            document.getElementById('modelDescription').value = model.description;
            document.getElementById('modelActive').checked = model.is_active;
            
            document.getElementById('modelModalTitle').textContent = 'Edit Model';
            document.getElementById('modelModal').style.display = 'block';
        }
        
        async function saveModel() {
            const id = document.getElementById('modelId').value;
            const data = {
                password: adminPassword,
                name: document.getElementById('modelName').value,
                display_name: document.getElementById('modelDisplayName').value,
                default_temperature: parseFloat(document.getElementById('modelTemperature').value),
                description: document.getElementById('modelDescription').value,
                is_active: document.getElementById('modelActive').checked
            };
            
            try {
                const url = id ? `${API_BASE}/admin/models/${id}` : `${API_BASE}/admin/models`;
                const method = id ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showAlert('success', result.message);
                    closeModal('modelModal');
                    loadModels();
                } else {
                    throw new Error(result.detail || 'Failed to save model');
                }
            } catch (error) {
                showAlert('danger', 'Failed to save model: ' + error.message);
            }
        }
        
        async function deleteModel(modelId) {
            const model = modelsData.find(m => m.id === modelId);
            if (!model) return;
            
            showConfirmModal(
                `Are you sure you want to delete model "${model.display_name}"?`,
                async () => {
                    try {
                        const response = await fetch(`${API_BASE}/admin/models/${modelId}?password=${encodeURIComponent(adminPassword)}`, {
                            method: 'DELETE'
                        });
                        
                        const result = await response.json();
                        
                        if (response.ok) {
                            showAlert('success', result.message);
                            loadModels();
                        } else {
                            throw new Error(result.detail || 'Failed to delete model');
                        }
                    } catch (error) {
                        showAlert('danger', 'Failed to delete model: ' + error.message);
                    }
                }
            );
        }
        
        async function toggleModel(modelId) {
            try {
                const response = await fetch(`${API_BASE}/admin/models/${modelId}/toggle`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password: adminPassword })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showAlert('success', result.message);
                    loadModels();
                } else {
                    throw new Error(result.detail || 'Failed to toggle model');
                }
            } catch (error) {
                showAlert('danger', 'Failed to toggle model: ' + error.message);
            }
        }
        
        // Tournament Management
        async function loadTournamentStatus() {
            document.getElementById('tournamentStatus').innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Loading tournament status...</p>
                </div>
            `;
            
            try {
                const response = await fetch(`${API_BASE}/tournament/status`);
                const data = await response.json();
                
                if (response.ok) {
                    displayTournamentStatus(data);
                } else {
                    throw new Error(data.detail || 'Failed to load tournament status');
                }
            } catch (error) {
                document.getElementById('tournamentStatus').innerHTML = `
                    <div class="alert alert-warning">
                        <p>Tournament status unavailable: ${error.message}</p>
                        <p><em>Tournament mode may not be enabled or tournament manager not initialized.</em></p>
                    </div>
                `;
            }
        }
        
        function displayTournamentStatus(status) {
            const currentPhase = status.phase || 'Unknown';
            const timeRemaining = status.time_remaining || 'N/A';
            const totalSubmissions = status.submission_count || 0;
            const selectedCharacters = status.selected_characters || [];
            
            let phaseDisplay = currentPhase;
            let phaseColor = '#6c757d';
            
            // Show/hide restart match button based on phase
            const restartBtn = document.getElementById('restart-match-btn');
            if (currentPhase.toLowerCase() === 'token_exhausted') {
                if (restartBtn) restartBtn.style.display = 'inline-block';
            } else {
                if (restartBtn) restartBtn.style.display = 'none';
            }
            
            switch(currentPhase.toLowerCase()) {
                case 'tournament_submit':
                    phaseDisplay = 'üìù Submission Phase';
                    phaseColor = '#17a2b8';
                    break;
                case 'tournament_voting':
                    phaseDisplay = 'üó≥Ô∏è Voting Phase';
                    phaseColor = '#f39c12';
                    break;
                case 'game':
                    phaseDisplay = 'üéÆ Game Phase';
                    phaseColor = '#28a745';
                    break;
                case 'token_exhausted':
                    phaseDisplay = '‚ö†Ô∏è TOKEN EXHAUSTED';
                    phaseColor = '#dc3545';
                    break;
                case 'tournament_end_screen':
                    phaseDisplay = 'üèÜ End Screen';
                    phaseColor = '#6f42c1';
                    break;
                default:
                    phaseDisplay = `‚ùì ${currentPhase}`;
            }
            
            let statusHtml = `
                <div style="padding: 20px;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                        <div style="background: ${phaseColor}; color: white; padding: 20px; border-radius: 8px; text-align: center;">
                            <h4 style="margin: 0; font-size: 1.2em;">${phaseDisplay}</h4>
                            <p style="margin: 5px 0 0 0; opacity: 0.9; font-size: 0.9em;">Current Phase</p>
                        </div>
                        <div style="background: #495057; color: white; padding: 20px; border-radius: 8px; text-align: center;">
                            <h4 style="margin: 0; font-size: 1.2em;">${timeRemaining}</h4>
                            <p style="margin: 5px 0 0 0; opacity: 0.9; font-size: 0.9em;">Time Remaining</p>
                        </div>
                        <div style="background: #17a2b8; color: white; padding: 20px; border-radius: 8px; text-align: center;">
                            <h4 style="margin: 0; font-size: 1.2em;">${totalSubmissions}</h4>
                            <p style="margin: 5px 0 0 0; opacity: 0.9; font-size: 0.9em;">Total Submissions</p>
                        </div>
                        <div style="background: #28a745; color: white; padding: 20px; border-radius: 8px; text-align: center;">
                            <h4 style="margin: 0; font-size: 1.2em;">${selectedCharacters.length}</h4>
                            <p style="margin: 5px 0 0 0; opacity: 0.9; font-size: 0.9em;">Selected Characters</p>
                        </div>
                    </div>
            `;
            
            if (selectedCharacters.length > 0) {
                statusHtml += `
                    <div style="margin-top: 20px;">
                        <h5 style="margin-bottom: 10px; color: #495057;">Selected Characters for Game:</h5>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 10px;">
                            ${selectedCharacters.map(char => `
                                <div style="background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 5px; padding: 10px;">
                                    <strong>${char.name}</strong><br>
                                    <small style="color: #6c757d;">Model: ${char.model_name} (temp: ${char.temperature})</small>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            
            statusHtml += '</div>';
            
            document.getElementById('tournamentStatus').innerHTML = statusHtml;
        }
        
        function refreshTournamentStatus() {
            loadTournamentStatus();
        }
        
        async function forceAdvanceTournamentPhase() {
            showConfirmModal(
                'Are you sure you want to force advance the tournament to the next phase? This will skip any remaining time in the current phase.',
                async () => {
                    try {
                        const response = await fetch(`${API_BASE}/tournament/advance-phase`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' }
                        });
                        
                        const result = await response.json();
                        
                        if (response.ok) {
                            showAlert('success', result.message || 'Tournament phase advanced successfully');
                            // Refresh tournament status after advancement
                            setTimeout(() => {
                                loadTournamentStatus();
                            }, 1000);
                        } else {
                            throw new Error(result.detail || 'Failed to advance tournament phase');
                        }
                    } catch (error) {
                        showAlert('danger', 'Failed to advance tournament phase: ' + error.message);
                    }
                }
            );
        }
        
        async function restartTournamentMatch() {
            showConfirmModal(
                'Are you sure you want to restart the tournament match? This will attempt to resume the game that was paused due to token exhaustion. Make sure API credits have been restored.',
                async () => {
                    const restartBtn = document.getElementById('restart-match-btn');
                    const originalText = restartBtn.textContent;
                    
                    try {
                        restartBtn.disabled = true;
                        restartBtn.textContent = 'üîÑ Restarting...';
                        
                        const response = await fetch(`${API_BASE}/tournament/restart-match`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ password: adminPassword })
                        });
                        
                        const result = await response.json();
                        
                        if (response.ok) {
                            restartBtn.textContent = '‚úÖ Restarted!';
                            showAlert('success', result.message || 'Tournament match restarted successfully');
                            
                            // Refresh tournament status after a short delay
                            setTimeout(() => {
                                loadTournamentStatus();
                                restartBtn.disabled = false;
                                restartBtn.textContent = originalText;
                            }, 2000);
                        } else {
                            throw new Error(result.detail || 'Failed to restart tournament match');
                        }
                    } catch (error) {
                        restartBtn.disabled = false;
                        restartBtn.textContent = originalText;
                        showAlert('danger', 'Failed to restart tournament match: ' + error.message);
                    }
                }
            );
        }
        
        // Tournament Controls
        async function syncModels() {
            try {
                const response = await fetch(`${API_BASE}/admin/models/sync`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password: adminPassword })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showAlert('success', `${result.message} (${result.models_updated} models updated)`);
                    loadModels();
                } else {
                    throw new Error(result.detail || 'Failed to sync models');
                }
            } catch (error) {
                showAlert('danger', 'Failed to sync models: ' + error.message);
            }
        }
        
        async function resetAllStats() {
            showConfirmModal(
                'Are you sure you want to reset all character statistics? This will set all wins and games played to 0.',
                async () => {
                    try {
                        const response = await fetch(`${API_BASE}/admin/characters/reset-stats`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ password: adminPassword })
                        });
                        
                        const result = await response.json();
                        
                        if (response.ok) {
                            showAlert('success', result.message);
                            loadCharacters();
                            loadDashboard();
                        } else {
                            throw new Error(result.detail || 'Failed to reset stats');
                        }
                    } catch (error) {
                        showAlert('danger', 'Failed to reset stats: ' + error.message);
                    }
                }
            );
        }
        
        async function clearVotes() {
            showConfirmModal(
                'Are you sure you want to clear all tournament votes?',
                async () => {
                    try {
                        const response = await fetch(`${API_BASE}/admin/tournament/clear-votes`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ 
                                password: adminPassword,
                                tournament_id: 'current'
                            })
                        });
                        
                        const result = await response.json();
                        
                        if (response.ok) {
                            showAlert('success', result.message);
                        } else {
                            throw new Error(result.detail || 'Failed to clear votes');
                        }
                    } catch (error) {
                        showAlert('danger', 'Failed to clear votes: ' + error.message);
                    }
                }
            );
        }
        
        // Games Management
        async function loadGames() {
            document.getElementById('gamesLoading').classList.remove('hidden');
            document.getElementById('gamesTable').classList.add('hidden');
            
            try {
                const response = await fetch(`${API_BASE}/admin/games?password=${encodeURIComponent(adminPassword)}`);
                const data = await response.json();
                
                if (response.ok) {
                    displayGames(data.games);
                } else {
                    throw new Error(data.detail || 'Failed to load games');
                }
            } catch (error) {
                showAlert('danger', 'Failed to load games: ' + error.message);
                document.getElementById('gamesTable').innerHTML = `
                    <div class="alert alert-warning">
                        <p>Failed to load games: ${error.message}</p>
                    </div>
                `;
            } finally {
                document.getElementById('gamesLoading').classList.add('hidden');
                document.getElementById('gamesTable').classList.remove('hidden');
            }
        }
        
        function displayGames(games) {
            if (games.length === 0) {
                document.getElementById('gamesTable').innerHTML = `
                    <div class="alert alert-info">
                        <p>No active games found.</p>
                    </div>
                `;
                return;
            }
            
            const tableHtml = `
                <table>
                    <thead>
                        <tr>
                            <th>Game ID</th>
                            <th>Type</th>
                            <th>Phase</th>
                            <th>Players</th>
                            <th>Turn</th>
                            <th>Active Player</th>
                            <th>Created</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${games.map(game => {
                            const gameType = game.is_tournament ? 
                                `üèÜ Tournament${game.tournament_phase ? ` (${game.tournament_phase})` : ''}` : 
                                'üéÆ Regular';
                            
                            const phaseDisplay = game.game_phase ? 
                                game.game_phase.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase()) : 
                                'Unknown';
                            
                            const createdDate = game.created_at ? 
                                new Date(game.created_at).toLocaleString() : 
                                'Unknown';
                            
                            return `
                                <tr>
                                    <td>
                                        <strong>${game.game_id}</strong><br>
                                        <small><a href="/dashboard?game=${game.game_id}" target="_blank">View Dashboard</a></small>
                                    </td>
                                    <td>${gameType}</td>
                                    <td>${phaseDisplay}</td>
                                    <td>
                                        <strong>${game.player_count}/${game.max_players || game.num_players}</strong><br>
                                        <small>${game.players.map(p => p.name).join(', ')}</small>
                                    </td>
                                    <td>${game.turn_number || 0}</td>
                                    <td>${game.active_player || 'None'}</td>
                                    <td>${createdDate}</td>
                                    <td class="actions">
                                        <button class="btn btn-small btn-warning" onclick="advanceGamePhase('${game.game_id}')">
                                            üöÄ Advance Phase
                                        </button>
                                        <button class="btn btn-small btn-danger" onclick="killGame('${game.game_id}', ${game.is_tournament})">
                                            üíÄ Kill Game
                                        </button>
                                    </td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            `;
            
            document.getElementById('gamesTable').innerHTML = tableHtml;
        }
        
        function refreshGames() {
            loadGames();
        }
        
        async function advanceGamePhase(gameId) {
            showConfirmModal(
                `Are you sure you want to force advance the phase for game "${gameId}"? This will skip any remaining actions in the current phase and move to the next phase.`,
                async () => {
                    try {
                        const response = await fetch(`${API_BASE}/games/force-advance-phase`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ 
                                game_id: gameId,
                                player_id: 'admin',
                                reason: 'admin_forced_advancement'
                            })
                        });
                        
                        const result = await response.json();
                        
                        if (response.ok) {
                            showAlert('success', result.message);
                            loadGames();
                        } else {
                            throw new Error(result.detail || 'Failed to advance game phase');
                        }
                    } catch (error) {
                        showAlert('danger', 'Failed to advance game phase: ' + error.message);
                    }
                }
            );
        }
        
        async function killGame(gameId, isTournament) {
            const warningText = isTournament ? 
                `Are you sure you want to kill tournament game "${gameId}"? This will end the current tournament game and may affect the tournament phase.` :
                `Are you sure you want to kill game "${gameId}"? This will immediately terminate the game for all players.`;
            
            showConfirmModal(
                warningText,
                async () => {
                    try {
                        const response = await fetch(`${API_BASE}/admin/games/${gameId}?password=${encodeURIComponent(adminPassword)}`, {
                            method: 'DELETE'
                        });
                        
                        const result = await response.json();
                        
                        if (response.ok) {
                            showAlert('success', result.message);
                            loadGames();
                            
                            // If it was a tournament game, refresh tournament status too
                            if (result.was_tournament) {
                                loadTournamentStatus();
                            }
                        } else {
                            throw new Error(result.detail || 'Failed to kill game');
                        }
                    } catch (error) {
                        showAlert('danger', 'Failed to kill game: ' + error.message);
                    }
                }
            );
        }
        
        // Utility Functions
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }
        
        function showAlert(type, message) {
            // Remove existing alerts
            document.querySelectorAll('.alert').forEach(alert => {
                if (!alert.id.includes('Error')) {
                    alert.remove();
                }
            });
            
            // Create new alert
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            
            // Insert at the top of the tab content
            const activeTab = document.querySelector('.tab-pane.active');
            if (activeTab) {
                activeTab.insertBefore(alert, activeTab.firstChild);
            }
            
            // Auto-hide after 5 seconds
            setTimeout(() => {
                alert.remove();
            }, 5000);
        }
        
        function showError(elementId, message) {
            const errorElement = document.getElementById(elementId);
            errorElement.textContent = message;
            errorElement.classList.remove('hidden');
        }
        
        function showConfirmModal(message, onConfirm) {
            document.getElementById('confirmMessage').textContent = message;
            document.getElementById('confirmButton').onclick = () => {
                closeModal('confirmModal');
                onConfirm();
            };
            document.getElementById('confirmModal').style.display = 'block';
        }
        
        // Close modals when clicking outside
        window.onclick = function(event) {
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            });
        }
        
        // Handle escape key to close modals
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                const visibleModal = document.querySelector('.modal[style*="block"]');
                if (visibleModal) {
                    visibleModal.style.display = 'none';
                }
            }
        });
    </script>
</body>
</html>
